<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prédiction Lucky Jet - Signal Unique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            margin: 0; padding: 0; background: #101728; color: #f4f4f4; font-family: 'Segoe UI', Arial, sans-serif;
        }
        .main-content {
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 36px;
        }
        .header {
            width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 22px 40px 10px 40px; box-sizing: border-box;
        }
        .user-info {
            display: flex; align-items: center; gap: 14px; font-weight: 500; font-size: 1.2em;
        }
        .user-avatar {
            width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, #4f8cff 0%, #49e6fb 100%);
            display: flex; align-items: center; justify-content: center; font-size: 1.4em; color: #fff; box-shadow: 0 2px 12px #242b3c4a;
        }
        .disconnect-btn {
            padding: 8px 18px; background: #161e31; border: none; border-radius: 17px; color: #fff; font-size: 1em; cursor: pointer; font-weight: 500;
            box-shadow: 0 2px 10px #242b3c1a; transition: background 0.2s; margin-left: 16px;
        }
        .disconnect-btn:hover { background: #49a6fb; color: #fff; }
        .connection-indicator {
            display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: flex-end; transition: color 0.25s;
        }
        .conn-bubble { width: 13px; height: 13px; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 6px #2223; animation: blink 1.3s infinite;}
        .conn-bubble.good { background: #41fd7c; }
        .conn-bubble.medium { background: #ffe066;}
        .conn-bubble.bad { background: #ff4c71;}
        .conn-text.good { color: #41fd7c; }
        .conn-text.medium { color: #ffe066;}
        .conn-text.bad { color: #ff4c71;}
        @keyframes blink { 0%, 100% { opacity: 1;} 50% { opacity: 0.45;} }

        .prediction-box {
            background: #1a2336; border-radius: 20px; box-shadow: 0 4px 18px #0e1b2a38; padding: 36px 30px; margin-top: 54px;
            display: flex; flex-direction: column; align-items: center; min-width: 320px; max-width: 96vw;
        }
        .predict-title { color: #49a6fb; font-size: 1.4em; font-weight: bold; margin-bottom: 18px; }
        .signal-btn {
            padding: 18px 52px; background: #49a6fb; color: #fff; font-size: 1.18em; border: none; border-radius: 15px;
            font-weight: bold; letter-spacing: 1px; cursor: pointer; margin-bottom: 12px; transition: background 0.20s, color 0.20s;
        }
        .signal-btn:disabled, .signal-btn.disabled { background: #2d3547; color: #eee; cursor: not-allowed;}
        .loading-animation {
            margin: 38px auto 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .circle-loader {
            border: 7px solid #49a6fb33;
            border-top: 7px solid #49a6fb;
            border-radius: 50%;
            width: 70px; height: 70px;
            animation: spin 1.2s linear infinite;
            margin-bottom: 30px;
        }
        @keyframes spin { 100% { transform: rotate(360deg);} }
        .loading-steps {
            color: #cce6ff; font-size: 1.08em; min-height: 26px; text-align: center; margin-bottom: 10px;
        }
        .predicted-cote {
            font-size: 2.1em; font-weight: bold; color: #40fd7c; margin-top: 30px; text-align: center;
            background: #181e2a; border-radius: 14px; padding: 18px 38px;
            box-shadow: 0 2px 14px #40fd7c33;
        }
        .error-message {
            color: #e74c3c; font-size: 1.1em; text-align: center; margin-top: 20px;
        }
        .info-message {
            color: #49a6fb; font-size: 1em; text-align: center; margin-top: 18px;
        }
        /* Pop-ups */
        .popup-bg {
            display: none; position: fixed; z-index: 100000; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.32); align-items: center; justify-content: center;
        }
        .popup {
            background: #1a2336; padding: 30px 26px 22px 26px; border-radius: 18px; color: #fff;
            box-shadow: 0 8px 32px #0009; text-align: center; min-width: 250px; max-width: 90vw;
            border: 2px solid #49a6fb; animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(26px);} to { opacity: 1; transform: translateY(0);} }
        .popup .fa-wifi-slash { color: #ff4c71; font-size: 2em; margin-bottom: 9px;}
        .popup-title { font-size: 1.13em; margin-bottom: 7px; font-weight: bold;}
        .popup .close-btn {
            margin-top: 16px; border: none; background: #49a6fb; color: #fff; padding: 8px 24px; border-radius: 14px;
            font-size: 1.01em; font-weight: 600; letter-spacing: .5px; cursor: pointer; transition: background 0.18s;
        }
        .popup .close-btn:hover { background: #ff6f92; }
        .popup input[type="text"] {
            padding: 9px 12px; border-radius: 10px; border: 1.5px solid #49a6fb; font-size: 1em; margin-top: 12px; margin-bottom: 10px; width: 75%;
            background: #181e2a; color: #fff; outline: none;
        }
        /* Responsive */
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 12px 4vw 7px 4vw;}
            .user-avatar { width: 29px; height: 29px; font-size: 1em; }
            .disconnect-btn { padding: 6px 9px; font-size: 0.9em; }
            .prediction-box { padding: 18px 3vw; }
            .predicted-cote { padding: 11px 12px; font-size: 1.3em;}
        }
    </style>
</head>
<body>
    <!-- Connexion perdue popup -->
    <div class="popup-bg" id="lost-connection-popup">
        <div class="popup">
            <i class="fa fa-wifi-slash"></i>
            <div class="popup-title">Connexion perdue</div>
            <div class="popup-text">
                Vous avez perdu votre connexion internet.<br>
                Veuillez vérifier votre réseau pour continuer à utiliser la prédiction.
            </div>
            <button class="close-btn" onclick="closePopup()">OK</button>
        </div>
    </div>
    <!-- Popup ID joueur -->
    <div class="popup-bg" id="id-popup">
        <div class="popup">
            <div class="popup-title">Entrez votre ID joueur 1win :</div>
            <input type="text" id="id-input" maxlength="32" placeholder="ID joueur..." autocomplete="off"/>
            <div id="id-error" style="color:#ff4c71;font-size:0.99em;"></div>
            <button class="close-btn" onclick="validateId()">Valider</button>
        </div>
    </div>
    <!-- Popup synchronisation -->
    <div class="popup-bg" id="sync-popup">
        <div class="popup">
            <div class="popup-title"><i class="fa fa-sync fa-spin"></i> Synchronisation...</div>
            <div style="font-size:1em; color:#49a6fb;">Veuillez patienter...</div>
        </div>
    </div>
    <div class="main-content" id="main-content" style="display:none;">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar"><i class="fa fa-user"></i></div>
                <span id="user-id">ID: —</span>
            </div>
            <div class="connection-indicator" id="connection-indicator">
                <span class="conn-bubble good" id="conn-bubble"></span>
                <span class="conn-text good" id="conn-text">Connecté</span>
            </div>
            <button class="disconnect-btn" onclick="logout()">Déconnexion</button>
        </div>
        <div class="prediction-box">
            <div class="predict-title">Signal Lucky Jet</div>
            <button class="signal-btn" id="signal-btn" onclick="startPrediction()">Rechercher le signal</button>
            <div class="loading-animation" id="loading-animation" style="display:none;">
                <div class="circle-loader"></div>
                <div class="loading-steps" id="loading-steps"></div>
            </div>
            <div class="predicted-cote" id="predicted-cote" style="display:none;"></div>
            <div class="error-message" id="error-message"></div>
            <div class="info-message" id="info-message"></div>
        </div>
    </div>
    <script>
        // --------- Gestion Connexion
        function setConnection(status) {
            const bubble = document.getElementById('conn-bubble');
            const text = document.getElementById('conn-text');
            if (status === 'good') {
                bubble.className = "conn-bubble good";
                text.className = "conn-text good";
                text.textContent = "Connecté";
            } else if (status === 'medium') {
                bubble.className = "conn-bubble medium";
                text.className = "conn-text medium";
                text.textContent = "Connexion lente";
            } else {
                bubble.className = "conn-bubble bad";
                text.className = "conn-text bad";
                text.textContent = "Déconnecté";
            }
        }
        function checkConnection() {
            if (navigator.onLine) {
                setConnection('good');
            } else {
                setConnection('bad');
                document.getElementById('lost-connection-popup').style.display = "flex";
            }
        }
        window.addEventListener('online', () => { setConnection('good'); });
        window.addEventListener('offline', () => {
            setConnection('bad');
            document.getElementById('lost-connection-popup').style.display = "flex";
        });
        function closePopup() {
            document.getElementById('lost-connection-popup').style.display = "none";
        }
        setInterval(checkConnection, 3000);

        // --------- Gestion ID joueur (mémoire + vérif backend)
        function getUserId() {
            return localStorage.getItem('luckyjet_userid');
        }
        function setUserId(id) {
            localStorage.setItem('luckyjet_userid', id);
        }
        function clearUserId() {
            localStorage.removeItem('luckyjet_userid');
        }
        function updateDisplayId() {
            const id = getUserId();
            document.getElementById('user-id').textContent = id ? "ID: " + id : "ID: —";
            document.getElementById('user-avatar').textContent = id ? id[0]?.toUpperCase() : "?";
        }

        // ---------- POPUP ID à l'arrivée
        async function showIdPopup(force = false) {
            document.getElementById('id-input').value = '';
            document.getElementById('id-error').textContent = '';
            document.getElementById('id-popup').style.display = "flex";
            // Désactive bouton
            document.getElementById('signal-btn').disabled = true;
        }
        async function validateId() {
            const id = document.getElementById('id-input').value.trim();
            if (!/^\d{6,15}$/.test(id)) {
                document.getElementById('id-error').textContent = "ID invalide. Entrez un numéro d’ID (chiffres, min 6).";
                return;
            }
            // Vérifie dans data/allowed_ids.txt (à créer côté serveur)
            document.getElementById('id-popup').style.display = "none";
            document.getElementById('sync-popup').style.display = "flex";
            try {
                const resp = await fetch('data/allowed_ids.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de vérifier l’ID.");
                const content = await resp.text();
                const allowedIds = content.split('\n').map(l=>l.trim()).filter(l=>l!=="");
                if (!allowedIds.includes(id)) {
                    document.getElementById('sync-popup').style.display = "none";
                    document.getElementById('id-error').textContent = "Cet ID n’existe pas dans la base.";
                    document.getElementById('id-popup').style.display = "flex";
                    return;
                }
                setUserId(id);
                document.getElementById('sync-popup').style.display = "none";
                updateDisplayId();
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
            } catch (e) {
                document.getElementById('sync-popup').style.display = "none";
                document.getElementById('id-error').textContent = "Erreur serveur: " + e.message;
                document.getElementById('id-popup').style.display = "flex";
            }
        }

        // Si bouton désactivé, popup ID forcé
        document.getElementById('signal-btn').addEventListener('click', function(e) {
            if (this.disabled) {
                showIdPopup(true);
            }
        });

        // ---------- Déconnexion
        function logout() {
            clearUserId();
            window.location.href = "index.html";
        }

        // ----------- Algorithme de prédiction avancé (50 dernières valeurs)
        // Utilise les règles (moyenne pondérée, EMA, médiane, tendance, etc.)
        function removeOutliers(data, factor = 2) {
            const values = data.map(x => x.value);
            const avg = values.reduce((a,b)=>a+b,0)/values.length;
            const std = Math.sqrt(values.reduce((s,v)=>s+Math.pow(v-avg,2),0)/values.length);
            return data.filter(x => Math.abs(x.value - avg) < factor * std);
        }
        function ema(values, alpha = 0.3) {
            let result = values[0];
            for (let i = 1; i < values.length; i++) {
                result = alpha * values[i] + (1 - alpha) * result;
            }
            return result;
        }
        function tendance(history, n = 8) {
            const recent = history.slice(-n);
            if (recent.length < 2) return 0;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < recent.length; i++) {
                sumX += i;
                sumY += recent[i].value;
                sumXY += i * recent[i].value;
                sumXX += i * i;
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return slope;
        }
        function moyennePonderee(history) {
            if (!history.length) return null;
            const recent = history.slice(-12);
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const recAvg = recent.length ? recent.reduce((s,v) => s+v.value,0)/recent.length : allAvg;
            const sorted = history.map(v => v.value).sort((a, b) => a - b);
            const median = sorted.length % 2 === 0 ?
                (sorted[sorted.length/2-1] + sorted[sorted.length/2]) / 2
                : sorted[Math.floor(sorted.length/2)];
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let poidsRecent = ecartType > 0.25 ? 0.40 : 0.65;
            let poidsGlobal = 0.25;
            let poidsMedian = ecartType > 0.25 ? 0.35 : 0.10;
            return recAvg * poidsRecent + allAvg * poidsGlobal + median * poidsMedian;
        }

        async function fetchLastPredictions(N = 50) {
            try {
                const resp = await fetch('data/prediction_data.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de charger les données.");
                const lines = (await resp.text()).split('\n').filter(l=>l.trim()!=="");
                const lastLines = lines.slice(-N);
                const data = lastLines.map(row => {
                    const [timestamp, value] = row.split('|').map(item => item.trim());
                    return { timestamp, value: parseFloat(value) };
                });
                return removeOutliers(data);
            } catch {
                return [];
            }
        }

        function randomStep() {
            const steps = [
                "Analyse des tendances récentes...",
                "Calcul de la moyenne pondérée...",
                "Détection des valeurs aberrantes...",
                "Lissage exponentiel en cours...",
                "Étude de la volatilité...",
                "Calcul de la médiane...",
                "Application de la tendance...",
                "Ajustement du signal final...",
                "Vérification de la cohérence...",
                "Génération du signal optimal...",
                "Finalisation de la prédiction..."
            ];
            return steps[Math.floor(Math.random()*steps.length)];
        }

        // ----------- Animation de chargement et calcul
        async function startPrediction() {
            document.getElementById('predicted-cote').style.display = "none";
            document.getElementById('error-message').textContent = '';
            document.getElementById('info-message').textContent = '';
            document.getElementById('signal-btn').disabled = true;
            // Animation chargement
            const anim = document.getElementById('loading-animation');
            const steps = document.getElementById('loading-steps');
            anim.style.display = "flex";
            steps.textContent = randomStep();
            let stepInterval = setInterval(() => { steps.textContent = randomStep(); }, 450);
            // Attente 10 secondes + calcul
            const history = await fetchLastPredictions(50);
            let cote = null;
            if (!history.length) {
                clearInterval(stepInterval);
                anim.style.display = "none";
                document.getElementById('error-message').textContent = "Erreur : Impossible de charger les données.";
                document.getElementById('signal-btn').disabled = false;
                return;
            }
            // Calcul avancé
            let predValue = moyennePonderee(history);
            // Ajoute EMA
            let emaValue = ema(history.map(v => v.value));
            predValue = (predValue + emaValue) / 2;
            // Ajoute bruit réaliste
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let bruit = (Math.random() + Math.random() + Math.random() - 1.5) * ecartType * 0.22;
            predValue += bruit;
            // Ajoute tendance
            let trend = tendance(history, 8);
            predValue += trend * 2;
            // Jamais sous 1.01
            if (predValue < 1.01) predValue = 1.01;
            cote = predValue.toFixed(2);

            // Attente 10s (ou 12s max)
            await new Promise(res => setTimeout(res, 10500 + Math.random()*1200));
            clearInterval(stepInterval);
            anim.style.display = "none";
            document.getElementById('predicted-cote').style.display = "block";
            document.getElementById('predicted-cote').textContent = "Cote prédite : " + cote;
            document.getElementById('info-message').textContent = "Basée sur l’analyse des 50 dernières données et l’intelligence avancée Lucky Jet.";
            document.getElementById('signal-btn').disabled = false;
        }

        // ----------- INIT
        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifie présence ID
            let id = getUserId();
            updateDisplayId();
            if (!id) {
                document.getElementById('main-content').style.display = "none";
                await new Promise(res=>setTimeout(res, 350)); // petit délai UX
                showIdPopup();
            } else {
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
            }
        });
    </script>
</body>
</html>