<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prédiction Aviator - Signal Unique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            margin: 0; padding: 0; background: #101019; color: #f4f4f4; font-family: 'Segoe UI', Arial, sans-serif;
        }
        .main-content {
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 36px;
        }
        .header {
            width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 22px 40px 10px 40px; box-sizing: border-box;
        }
        .user-info {
            display: flex; align-items: center; gap: 14px; font-weight: 500; font-size: 1.2em;
        }
        .user-avatar {
            width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, #ff4c71 0%, #ff2222 100%);
            display: flex; align-items: center; justify-content: center; font-size: 1.4em; color: #fff; box-shadow: 0 2px 12px #ff4c7166;
        }
        .disconnect-btn {
            padding: 8px 18px; background: #2b141a; border: none; border-radius: 17px; color: #fff; font-size: 1em; cursor: pointer; font-weight: 500;
            box-shadow: 0 2px 10px #ff4c711a; transition: background 0.2s; margin-left: 16px;
        }
        .disconnect-btn:hover { background: #ff4c71; color: #fff; }
        .connection-indicator {
            display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: flex-end; transition: color 0.25s;
        }
        .conn-bubble { width: 13px; height: 13px; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 6px #2223; animation: blink 1.3s infinite;}
        .conn-bubble.good { background: #ff4c71; }
        .conn-bubble.medium { background: #ffe066;}
        .conn-bubble.bad { background: #ff2222;}
        .conn-text.good { color: #ff4c71; }
        .conn-text.medium { color: #ffe066;}
        .conn-text.bad { color: #ff2222;}
        @keyframes blink { 0%, 100% { opacity: 1;} 50% { opacity: 0.45;} }

        .prediction-box {
            background: #1a1221; border-radius: 20px; box-shadow: 0 4px 18px #ff4c7138; padding: 36px 30px; margin-top: 54px;
            display: flex; flex-direction: column; align-items: center; min-width: 320px; max-width: 96vw;
        }
        .predict-title { color: #ff4c71; font-size: 1.4em; font-weight: bold; margin-bottom: 18px; }

        .signal-btn {
            padding: 18px 52px; background: #ff4c71; color: #fff; font-size: 1.18em; border: none; border-radius: 15px;
            font-weight: bold; letter-spacing: 1px; cursor: pointer; margin-bottom: 12px; transition: background 0.20s, color 0.20s;
        }
        .signal-btn:disabled, .signal-btn.disabled { background: #2d1a26; color: #eee; cursor: not-allowed;}

        /* Nouvelle animation centrale */
        .big-loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto 30px auto;
        }
        .big-circle-loader {
            border: 18px solid #ff4c711a;
            border-top: 18px solid #ff4c71;
            border-right: 18px solid #ffb4c7;
            border-bottom: 18px solid #ff4c71bb;
            border-left: 18px solid #2d1a26;
            border-radius: 50%;
            width: 220px;
            height: 220px;
            animation: bigspin 1.3s linear infinite;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            box-shadow: 0 4px 28px #ff4c7133, 0 0 0 10px #ff4c7112 inset;
        }
        @keyframes bigspin {
            100% { transform: rotate(360deg);}
        }
        .cotes-rotate {
            position: absolute;
            width: 220px;
            height: 220px;
            top: 0; left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            pointer-events: none;
        }
        .cote-item {
            position: absolute;
            left: 50%; top: 50%;
            transform-origin: -90px center;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 12px #ff4c7188;
            opacity: 0.92;
            transition: color 0.2s;
        }
        .cote-item.highlight {
            font-size: 2.1em;
            color: #ff4c71;
            text-shadow: 0 0 16px #ff4c71cc;
            opacity: 1;
        }

        /* Bandeau étapes techniques (console) */
        .steps-console {
            width: 98%;
            max-width: 400px;
            margin: 0 auto 0 auto;
            background: #23182b;
            border-radius: 12px;
            box-shadow: 0 1px 8px #2222;
            padding: 7px 12px;
            min-height: 26px;
            font-family: 'Fira Mono', monospace;
            font-size: 0.99em;
            color: #ffb4c7;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .console-line {
            opacity: 1;
            transition: opacity 0.15s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .predicted-cote {
            font-size: 2.1em; font-weight: bold; color: #ff4c71; margin-top: 30px; text-align: center;
            background: #2d1a26; border-radius: 14px; padding: 18px 38px;
            box-shadow: 0 2px 14px #ff4c7133;
        }
        .predicted-hour {
            font-size: 1.05em;
            color: #ffb4c7;
            margin-top: 8px;
            font-weight: bold;
        }
        .error-message {
            color: #e74c3c; font-size: 1.1em; text-align: center; margin-top: 20px;
        }
        .info-message {
            color: #ff4c71; font-size: 1em; text-align: center; margin-top: 18px;
        }
        /* Pop-ups */
        .popup-bg {
            display: none; position: fixed; z-index: 100000; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.32); align-items: center; justify-content: center;
        }
        .popup {
            background: #1a1221; padding: 30px 26px 22px 26px; border-radius: 18px; color: #fff;
            box-shadow: 0 8px 32px #ff4c7166; text-align: center; min-width: 250px; max-width: 90vw;
            border: 2px solid #ff4c71; animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(26px);} to { opacity: 1; transform: translateY(0);} }
        .popup .fa-wifi-slash { color: #ff4c71; font-size: 2em; margin-bottom: 9px;}
        .popup-title { font-size: 1.13em; margin-bottom: 7px; font-weight: bold;}
        .popup .close-btn {
            margin-top: 16px; border: none; background: #ff4c71; color: #fff; padding: 8px 24px; border-radius: 14px;
            font-size: 1.01em; font-weight: 600; letter-spacing: .5px; cursor: pointer; transition: background 0.18s;
        }
        .popup .close-btn:hover { background: #ff2222; }
        .popup input[type="text"] {
            padding: 9px 12px; border-radius: 10px; border: 1.5px solid #ff4c71; font-size: 1em; margin-top: 12px; margin-bottom: 10px; width: 75%;
            background: #2d1a26; color: #fff; outline: none;
        }
        /* Responsive */
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 12px 4vw 7px 4vw;}
            .user-avatar { width: 29px; height: 29px; font-size: 1em; }
            .disconnect-btn { padding: 6px 9px; font-size: 0.9em; }
            .prediction-box { padding: 18px 3vw; }
            .predicted-cote { padding: 11px 12px; font-size: 1.3em;}
            .big-loader-container { width: 160px; height: 160px;}
            .big-circle-loader, .cotes-rotate { width: 130px; height: 130px; }
        }
    </style>
</head>
<body>
    <!-- Connexion perdue popup -->
    <div class="popup-bg" id="lost-connection-popup">
        <div class="popup">
            <i class="fa fa-wifi-slash"></i>
            <div class="popup-title">Connexion perdue</div>
            <div class="popup-text">
                Vous avez perdu votre connexion internet.<br>
                Veuillez vérifier votre réseau pour continuer à utiliser la prédiction.
            </div>
            <button class="close-btn" onclick="closePopup()">OK</button>
        </div>
    </div>
    <!-- Popup ID joueur -->
    <div class="popup-bg" id="id-popup">
        <div class="popup">
            <div class="popup-title">Entrez votre ID joueur Aviator :</div>
            <input type="text" id="id-input" maxlength="32" placeholder="ID joueur..." autocomplete="off"/>
            <div id="id-error" style="color:#ff4c71;font-size:0.99em;"></div>
            <button class="close-btn" onclick="validateId()">Valider</button>
        </div>
    </div>
    <!-- Popup synchronisation -->
    <div class="popup-bg" id="sync-popup">
        <div class="popup">
            <div class="popup-title"><i class="fa fa-sync fa-spin"></i> Synchronisation...</div>
            <div style="font-size:1em; color:#ff4c71;">Veuillez patienter...</div>
        </div>
    </div>
    <div class="main-content" id="main-content" style="display:none;">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar"><i class="fa fa-user"></i></div>
                <span id="user-id">ID: —</span>
            </div>
            <div class="connection-indicator" id="connection-indicator">
                <span class="conn-bubble good" id="conn-bubble"></span>
                <span class="conn-text good" id="conn-text">Connecté</span>
            </div>
            <button class="disconnect-btn" onclick="logout()">Déconnexion</button>
        </div>
        <div class="prediction-box">
            <div class="predict-title">Signal Aviator</div>
            <button class="signal-btn" id="signal-btn" onclick="startPrediction()">Rechercher le signal</button>
            <!-- Nouvelle animation centrale -->
            <div class="big-loader-container" id="big-loader-container" style="display:none;">
                <div class="big-circle-loader"></div>
                <div class="cotes-rotate" id="cotes-rotate"></div>
            </div>
            <div class="steps-console" id="steps-console" style="display:none;"></div>
            <div class="predicted-cote" id="predicted-cote" style="display:none;"></div>
            <div class="predicted-hour" id="predicted-hour" style="display:none;"></div>
            <div class="error-message" id="error-message"></div>
            <div class="info-message" id="info-message"></div>
        </div>
    </div>
    <script>
        // --------- Gestion Connexion
        function setConnection(status) {
            const bubble = document.getElementById('conn-bubble');
            const text = document.getElementById('conn-text');
            if (status === 'good') {
                bubble.className = "conn-bubble good";
                text.className = "conn-text good";
                text.textContent = "Connecté";
            } else if (status === 'medium') {
                bubble.className = "conn-bubble medium";
                text.className = "conn-text medium";
                text.textContent = "Connexion lente";
            } else {
                bubble.className = "conn-bubble bad";
                text.className = "conn-text bad";
                text.textContent = "Déconnecté";
            }
        }
        function checkConnection() {
            if (navigator.onLine) {
                setConnection('good');
            } else {
                setConnection('bad');
                document.getElementById('lost-connection-popup').style.display = "flex";
            }
        }
        window.addEventListener('online', () => { setConnection('good'); });
        window.addEventListener('offline', () => {
            setConnection('bad');
            document.getElementById('lost-connection-popup').style.display = "flex";
        });
        function closePopup() {
            document.getElementById('lost-connection-popup').style.display = "none";
        }
        setInterval(checkConnection, 3000);

        // --------- Gestion ID joueur (mémoire + vérif backend)
        function getUserId() {
            return localStorage.getItem('aviator_userid');
        }
        function setUserId(id) {
            localStorage.setItem('aviator_userid', id);
        }
        function clearUserId() {
            localStorage.removeItem('aviator_userid');
        }
        function updateDisplayId() {
            const id = getUserId();
            document.getElementById('user-id').textContent = id ? "ID: " + id : "ID: —";
            document.getElementById('user-avatar').textContent = id ? id[0]?.toUpperCase() : "?";
        }

        // ---------- POPUP ID à l'arrivée (une seule fois)
        async function showIdPopup(force = false) {
            document.getElementById('id-input').value = '';
            document.getElementById('id-error').textContent = '';
            document.getElementById('id-popup').style.display = "flex";
            document.getElementById('signal-btn').disabled = true;
        }
        async function validateId() {
            const id = document.getElementById('id-input').value.trim();
            if (!/^\d{6,15}$/.test(id)) {
                document.getElementById('id-error').textContent = "ID invalide. Entrez un numéro d’ID (chiffres, min 6).";
                return;
            }
            document.getElementById('id-popup').style.display = "none";
            document.getElementById('sync-popup').style.display = "flex";
            try {
                const resp = await fetch('data/allowed_ids.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de vérifier l’ID.");
                const content = await resp.text();
                const allowedIds = content.split('\n').map(l=>l.trim()).filter(l=>l!=="");
                if (!allowedIds.includes(id)) {
                    document.getElementById('sync-popup').style.display = "none";
                    document.getElementById('id-error').textContent = "Cet ID n’existe pas dans la base.";
                    document.getElementById('id-popup').style.display = "flex";
                    return;
                }
                setUserId(id);
                document.getElementById('sync-popup').style.display = "none";
                updateDisplayId();
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
            } catch (e) {
                document.getElementById('sync-popup').style.display = "none";
                document.getElementById('id-error').textContent = "Erreur serveur: " + e.message;
                document.getElementById('id-popup').style.display = "flex";
            }
        }

        // ---------- Déconnexion
        function logout() {
            clearUserId();
            window.location.href = "index.html";
        }

        // ----------- ALGORITHME DE CALCUL AVANCÉ (50 dernières valeurs) -----------
        function removeOutliers(data, factor = 2) {
            const values = data.map(x => x.value);
            const avg = values.reduce((a,b)=>a+b,0)/values.length;
            const std = Math.sqrt(values.reduce((s,v)=>s+Math.pow(v-avg,2),0)/values.length);
            return data.filter(x => Math.abs(x.value - avg) < factor * std);
        }
        function ema(values, alpha = 0.3) {
            let result = values[0];
            for (let i = 1; i < values.length; i++) {
                result = alpha * values[i] + (1 - alpha) * result;
            }
            return result;
        }
        function tendance(history, n = 8) {
            const recent = history.slice(-n);
            if (recent.length < 2) return 0;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < recent.length; i++) {
                sumX += i;
                sumY += recent[i].value;
                sumXY += i * recent[i].value;
                sumXX += i * i;
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return slope;
        }
        function moyennePonderee(history) {
            if (!history.length) return null;
            const recent = history.slice(-12);
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const recAvg = recent.length ? recent.reduce((s,v) => s+v.value,0)/recent.length : allAvg;
            const sorted = history.map(v => v.value).sort((a, b) => a - b);
            const median = sorted.length % 2 === 0 ?
                (sorted[sorted.length/2-1] + sorted[sorted.length/2]) / 2
                : sorted[Math.floor(sorted.length/2)];
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let poidsRecent = ecartType > 0.25 ? 0.40 : 0.65;
            let poidsGlobal = 0.25;
            let poidsMedian = ecartType > 0.25 ? 0.35 : 0.10;
            return recAvg * poidsRecent + allAvg * poidsGlobal + median * poidsMedian;
        }
        async function fetchLastPredictions(N = 50) {
            try {
                const resp = await fetch('data/prediction_data.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de charger les données.");
                const lines = (await resp.text()).split('\n').filter(l=>l.trim()!=="");
                const lastLines = lines.slice(-N);
                const data = lastLines.map(row => {
                    const [timestamp, value] = row.split('|').map(item => item.trim());
                    return { timestamp, value: parseFloat(value) };
                });
                return removeOutliers(data);
            } catch {
                return [];
            }
        }

        // ----------- Animation de chargement et calcul avancé -----------
        // Côtes fictives pour l’animation circulaire
        function getRandomCotes(count = 7) {
            const arr = [];
            for (let i = 0; i < count; i++) {
                // Valeurs aléatoires typiques
                let v = (Math.random() * 10 + 1.1).toFixed(2);
                arr.push(v);
            }
            return arr;
        }

        // Étapes techniques crédibles façon console
        function getFastSteps() {
            return [
                "Extraction des séquences...",
                "Initialisation des coefficients...",
                "Recherche de patterns récents...",
                "Synchronisation des matrices...",
                "Évaluation des volatilités...",
                "Calcul du facteur d’instabilité...",
                "Analyse des clusters internes...",
                "Préparation des poids dynamiques...",
                "Transmission des batchs...",
                "Optimisation des signaux...",
                "Ajustement des coefficients...",
                "Application de la fenêtre de Hann...",
                "Mise à l’échelle des paramètres...",
                "Filtrage des signaux parasites...",
                "Calcul du gradient récent...",
                "Sélection de la tendance locale...",
                "Finalisation du modèle...",
                "Synchronisation serveur...",
                "Signal généré.",
            ];
        }

        // Nouvelle animation centrale : cercle et côtes qui tournent
        let spinningInterval = null;
        let stepsInterval = null;
        let animationTimeout = null;
        let currentIndex = 0;

        function showBigLoader(predictedValue = null) {
            const loader = document.getElementById('big-loader-container');
            const cotesContainer = document.getElementById('cotes-rotate');
            loader.style.display = "flex";
            cotesContainer.innerHTML = "";
            const cotes = getRandomCotes(9);
            // Ajoute la prédiction au hasard dans le cercle (mais masquée avant la fin)
            if (predictedValue) {
                const pos = Math.floor(Math.random()*cotes.length);
                cotes[pos] = predictedValue;
            }
            let angleStep = 360 / cotes.length;

            // Crée les éléments des côtes
            for (let i = 0; i < cotes.length; i++) {
                const span = document.createElement('span');
                span.className = "cote-item";
                span.textContent = cotes[i];
                span.style.transform = `rotate(${i*angleStep}deg) translate(-90px)`;
                cotesContainer.appendChild(span);
            }
            currentIndex = 0;

            spinningInterval = setInterval(() => {
                // Fait tourner les côtes
                let children = Array.from(cotesContainer.children);
                children.forEach((el, idx) => {
                    el.classList.remove('highlight');
                    let deg = ((idx - currentIndex + children.length) % children.length) * angleStep;
                    el.style.transform = `rotate(${deg}deg) translate(-90px)`;
                    if (idx === currentIndex % children.length) {
                        el.classList.add('highlight');
                    }
                });
                currentIndex = (currentIndex + 1) % children.length;
            }, 210);
        }

        function hideBigLoader() {
            document.getElementById('big-loader-container').style.display = "none";
            document.getElementById('cotes-rotate').innerHTML = "";
            clearInterval(spinningInterval);
        }

        // Animation console rapide
        function showStepsConsole() {
            const steps = getFastSteps();
            const consoleBox = document.getElementById('steps-console');
            consoleBox.style.display = "flex";
            consoleBox.innerHTML = "";
            let lineIdx = 0;
            stepsInterval = setInterval(() => {
                // Ajoute une nouvelle ligne, mais retire la précédente (pour effet rapide)
                if (lineIdx < steps.length) {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = "console-line";
                    lineDiv.textContent = steps[lineIdx];
                    consoleBox.appendChild(lineDiv);
                    if (consoleBox.children.length > 2) {
                        // On ne garde que 2 lignes max visibles
                        consoleBox.children[0].style.opacity = 0.15;
                        setTimeout(()=>{ if(consoleBox.children[0]) consoleBox.removeChild(consoleBox.children[0]); }, 70);
                    }
                    lineIdx++;
                } else {
                    clearInterval(stepsInterval);
                }
            }, 65); // défilement ultra rapide
        }
        function hideStepsConsole() {
            clearInterval(stepsInterval);
            document.getElementById('steps-console').style.display = "none";
            document.getElementById('steps-console').innerHTML = "";
        }

        // ----------- Lancement de la prédiction avancée -----------
        async function startPrediction() {
            // Vérifie si ID mémorisé, sinon refuse
            if (!getUserId()) {
                showIdPopup();
                return;
            }
            document.getElementById('predicted-cote').style.display = "none";
            document.getElementById('predicted-hour').style.display = "none";
            document.getElementById('error-message').textContent = '';
            document.getElementById('info-message').textContent = '';
            document.getElementById('signal-btn').disabled = true;

            // Animation moderne
            showBigLoader();
            showStepsConsole();

            // Récupération et calcul
            const history = await fetchLastPredictions(50);
            let cote = null;
            if (!history.length) {
                hideBigLoader();
                hideStepsConsole();
                document.getElementById('error-message').textContent = "Erreur : Impossible de charger les données.";
                document.getElementById('signal-btn').disabled = false;
                return;
            }
            // Calcul avancé
            let predValue = moyennePonderee(history);
            let emaValue = ema(history.map(v => v.value));
            predValue = (predValue + emaValue) / 2;
            // Ajoute bruit réaliste
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let bruit = (Math.random() + Math.random() + Math.random() - 1.5) * ecartType * 0.28;
            predValue += bruit;
            // Ajoute tendance
            let trend = tendance(history, 8);
            predValue += trend * 2;
            // Jamais sous 1.01
            if (predValue < 1.01) predValue = 1.01;
            cote = predValue.toFixed(2);

            // Durée d’attente réaliste 10-12s
            await new Promise(res => setTimeout(res, 10000 + Math.random()*2000));
            // Fait tourner le loader avec la vraie cote pendant 0.8s à la fin :
            hideBigLoader();
            showBigLoader(cote);
            await new Promise(res => setTimeout(res, 800));
            hideBigLoader();
            hideStepsConsole();

            // Affiche la prédiction
            document.getElementById('predicted-cote').style.display = "block";
            document.getElementById('predicted-cote').textContent = "Cote prédite : " + cote;
            // Heure actuelle locale
            const d = new Date();
            const heure = d.getHours().toString().padStart(2, '0') + ":" +
                          d.getMinutes().toString().padStart(2, '0') + ":" +
                          d.getSeconds().toString().padStart(2, '0');
            document.getElementById('predicted-hour').style.display = "block";
            document.getElementById('predicted-hour').textContent = "Heure de prédiction : " + heure;
            document.getElementById('info-message').textContent = "Basée sur l’analyse intelligente Aviator (50 dernières données).";
            document.getElementById('signal-btn').disabled = false;
        }

        // ----------- INIT
        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifie présence ID
            let id = getUserId();
            updateDisplayId();
            if (!id) {
                document.getElementById('main-content').style.display = "none";
                await new Promise(res=>setTimeout(res, 350)); // petit délai UX
                showIdPopup();
            } else {
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
            }
        });
    </script>
</body>
</html>