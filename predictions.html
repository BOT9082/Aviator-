<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pr√©diction Aviator - Signal Unique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100vw; min-height: 100vh;
            background: radial-gradient(ellipse at 50% 20%, #191932 60%, #101019 100%);
            color: #f4f4f4; font-family: 'Segoe UI', Arial, sans-serif; overflow-x: hidden;
        }
        body { max-width: 100vw; }
        .main-content {
            min-height: 100vh; width: 100vw;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 10px; box-sizing: border-box;
        }
        .prediction-box {
            background: linear-gradient(135deg, #191932 60%, #1a1221 100%);
            border-radius: 22px;
            box-shadow: 0 4px 24px #ff4c7138, 0 2px 24px #19193255;
            padding: 30px 6vw 30px 6vw;
            margin-top: 32px;
            display: flex; flex-direction: column; align-items: stretch;
            min-width: 0; width: 97vw; max-width: 430px;
            border: 1.5px solid #332040;
            position: relative;
        }
        .box-header {
            display: flex; align-items: center; justify-content: flex-start;
            margin-bottom: 18px;
        }
        #user-id-display {
            color: #ffb4c7;
            font-size: 1em;
            font-family: 'Fira Mono', 'Consolas', monospace;
            opacity: 0.90;
            background: #291a2650;
            padding: 7px 14px 7px 13px;
            border-radius: 13px;
            border: 1px solid #ffb4c740;
            min-width: 62px;
            margin-right: 14px;
            letter-spacing: 0.03em;
            box-shadow: 0 2px 10px #ff4c7130;
        }
        .predict-title {
            color: #fff; font-size: 1.23em; font-weight: bold; letter-spacing: 0.03em;
            text-shadow: 0 2px 12px #ff4c7140;
        }
        /* Minuteur */
        #timer-remaining {
            display: none;
            margin: 17px auto 2px auto;
            font-size: 1.18em;
            font-family: 'Fira Mono','Consolas',monospace;
            color: #ffe484;
            background: #23202985;
            padding: 9px 18px;
            border-radius: 18px;
            text-align: center;
            min-width: 130px;
            box-shadow: 0 2px 10px #ffe48420;
            font-weight: bold;
            letter-spacing: 0.04em;
        }
        /* LOGS fa√ßon console, sans fen√™tre */
        #analysis-logs {
            font-family: 'Fira Mono', 'Consolas', monospace;
            font-size: 0.89em;
            color: #00ff99;
            letter-spacing: 0.01em;
            white-space: nowrap;
            opacity: 0.93;
            user-select: none;
            margin: 8px 0 6px 0;
            min-height: 1.1em;
            text-align: left;
        }
        .predicted-cote {
            font-size: 2em; font-weight: bold; color: #ff4c71; margin-top: 6px; text-align: center;
            background: linear-gradient(90deg, #2d1a26 60%, #20151c 100%);
            border-radius: 14px; padding: 16px 14px;
            box-shadow: 0 2px 14px #ff4c7133;
            border: 1.2px solid #ff4c7130;
            width: 100%; max-width: 340px; margin: 0 auto;
        }
        .predicted-hour {
            font-size: 1.08em; color: #ffb4c7; margin-top: 10px; font-weight: bold; text-shadow: 0 1px 6px #21101d;
            text-align: center;
        }
        .error-message {
            color: #e74c3c; font-size: 1.1em; text-align: center; margin-top: 18px;
        }
        .info-message {
            color: #ff4c71; font-size: 1em; text-align: center; margin-top: 16px;
        }
        .signal-btn {
            display: block;
            margin: 23px auto 0 auto;
            width: 90vw; max-width: 340px;
            padding: 19px 0;
            background: linear-gradient(90deg, #ff4c71 60%, #ffb4c7 100%);
            color: #fff; font-size: 1.18em; border: none; border-radius: 17px;
            font-weight: bold; letter-spacing: 1px; cursor: pointer;
            transition: background 0.20s, color 0.20s, box-shadow 0.25s;
            box-shadow: 0 2px 22px #ff4c7130, 0 0 8px #ff4c7140;
            z-index: 9999;
            text-align: center;
        }
        .signal-btn:disabled, .signal-btn.disabled {
            background: #2d1a26 !important;
            color: #eee;
            cursor: not-allowed;
            box-shadow: none;
        }
        @media (max-width: 600px) {
            .prediction-box { padding: 20px 2vw 22px 2vw; border-radius: 11px; }
            #user-id-display { font-size: 0.97em; padding: 5px 10px 5px 9px; border-radius: 9px; min-width: 48px; }
            .predict-title { font-size: 1em;}
            #timer-remaining { font-size: 1em; padding: 7px 6vw; border-radius: 12px;}
            .predicted-cote { font-size: 1.12em; padding: 8px 2vw;}
            .signal-btn { font-size: 1em; padding: 12px 0;}
        }
        @media (min-width: 900px) {
            body, html, .main-content, .prediction-box, .signal-btn {
                display: none !important;
            }
            body::before {
                content: 'Disponible uniquement sur mobile üì±';
                color: #ff4c71; background: #181828;
                display: block; text-align: center; font-size: 2.1em; padding: 15vh 12vw; width: 100vw; min-height: 100vh;
            }
        }
        /* Popups inchang√©s */
        .popup-bg {
            display: none; position: fixed; z-index: 100000; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.32); align-items: center; justify-content: center;
        }
        .popup {
            background: #1a1221; padding: 30px 26px 22px 26px; border-radius: 18px; color: #fff;
            box-shadow: 0 8px 32px #ff4c7166; text-align: center; min-width: 250px; max-width: 90vw;
            border: 2px solid #ff4c71; animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(26px);} to { opacity: 1; transform: translateY(0);} }
        .popup .fa-wifi-slash { color: #ff4c71; font-size: 2em; margin-bottom: 9px;}
        .popup-title { font-size: 1.13em; margin-bottom: 7px; font-weight: bold;}
        .popup .close-btn {
            margin-top: 16px; border: none; background: #ff4c71; color: #fff; padding: 8px 24px; border-radius: 14px;
            font-size: 1.01em; font-weight: 600; letter-spacing: .5px; cursor: pointer; transition: background 0.18s;
        }
        .popup .close-btn:hover { background: #ff2222; }
        .popup input[type="text"] {
            padding: 9px 12px; border-radius: 10px; border: 1.5px solid #ff4c71; font-size: 1em; margin-top: 12px; margin-bottom: 10px; width: 75%;
            background: #2d1a26; color: #fff; outline: none;
        }
    </style>
</head>
<body>
    <!-- Connexion perdue popup -->
    <div class="popup-bg" id="lost-connection-popup">
        <div class="popup">
            <i class="fa fa-wifi-slash"></i>
            <div class="popup-title">Connexion perdue</div>
            <div class="popup-text">
                Vous avez perdu votre connexion internet.<br>
                Veuillez v√©rifier votre r√©seau pour continuer √† utiliser la pr√©diction.
            </div>
            <button class="close-btn" onclick="closePopup()">OK</button>
        </div>
    </div>
    <!-- Popup ID joueur -->
    <div class="popup-bg" id="id-popup">
        <div class="popup">
            <div class="popup-title">Entrez votre ID joueur Aviator :</div>
            <input type="text" id="id-input" maxlength="32" placeholder="ID joueur..." autocomplete="off"/>
            <div id="id-error" style="color:#ff4c71;font-size:0.99em;"></div>
            <button class="close-btn" onclick="validateId()">Valider</button>
        </div>
    </div>
    <!-- Popup synchronisation -->
    <div class="popup-bg" id="sync-popup">
        <div class="popup">
            <div class="popup-title"><i class="fa fa-sync fa-spin"></i> Synchronisation...</div>
            <div style="font-size:1em; color:#ff4c71;">Veuillez patienter...</div>
        </div>
    </div>
    <div class="main-content" id="main-content" style="display:none;">
        <div class="prediction-box">
            <div class="box-header">
                <div id="user-id-display" style="display:none"></div>
                <div class="predict-title">Signal Aviator</div>
            </div>
            <div id="timer-remaining"></div>
            <div id="analysis-logs"></div>
            <div class="predicted-cote" id="predicted-cote" style="display:none;"></div>
            <div class="predicted-hour" id="predicted-hour" style="display:none;"></div>
            <div class="error-message" id="error-message"></div>
            <div class="info-message" id="info-message"></div>
        </div>
        <button class="signal-btn" id="signal-btn" onclick="startPrediction()">Rechercher le signal</button>
    </div>
    <script>
        // --------- Gestion Connexion
        let interrupted = false;
        function setConnection(status) {}
        function checkConnection() {
            if (!navigator.onLine) {
                interrupted = true;
                document.getElementById('lost-connection-popup').style.display = "flex";
            }
        }
        window.addEventListener('online', () => {});
        window.addEventListener('offline', () => {
            interrupted = true;
            document.getElementById('lost-connection-popup').style.display = "flex";
        });
        function closePopup() {
            document.getElementById('lost-connection-popup').style.display = "none";
        }
        setInterval(checkConnection, 2000);

        // --------- Gestion ID joueur
        function getUserId() {
            return localStorage.getItem('aviator_userid');
        }
        function setUserId(id) {
            localStorage.setItem('aviator_userid', id);
        }
        function clearUserId() {
            localStorage.removeItem('aviator_userid');
        }
        function showUserIdOnPage() {
            const id = getUserId();
            const el = document.getElementById('user-id-display');
            if (id) {
                el.textContent = "ID : " + id;
                el.style.display = "block";
            } else {
                el.style.display = "none";
            }
        }

        async function showIdPopup(force = false) {
            document.getElementById('id-input').value = '';
            document.getElementById('id-error').textContent = '';
            document.getElementById('id-popup').style.display = "flex";
            document.getElementById('signal-btn').disabled = true;
        }
        async function validateId() {
            const id = document.getElementById('id-input').value.trim();
            if (!/^\d{6,15}$/.test(id)) {
                document.getElementById('id-error').textContent = "ID invalide. Entrez un num√©ro d‚ÄôID (chiffres, min 6).";
                return;
            }
            document.getElementById('id-popup').style.display = "none";
            document.getElementById('sync-popup').style.display = "flex";
            // Simulation d'un vrai d√©lai de synchro (4s)
            await new Promise(res=>setTimeout(res, 4000));
            try {
                const resp = await fetch('data/allowed_ids.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de v√©rifier l‚ÄôID.");
                const content = await resp.text();
                const allowedIds = content.split('\n').map(l=>l.trim()).filter(l=>l!=="");
                if (!allowedIds.includes(id)) {
                    document.getElementById('sync-popup').style.display = "none";
                    document.getElementById('id-error').textContent = "Cet ID n‚Äôexiste pas dans la base.";
                    document.getElementById('id-popup').style.display = "flex";
                    return;
                }
                setUserId(id);
                document.getElementById('sync-popup').style.display = "none";
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
                showUserIdOnPage();
            } catch (e) {
                document.getElementById('sync-popup').style.display = "none";
                document.getElementById('id-error').textContent = "Erreur serveur: " + e.message;
                document.getElementById('id-popup').style.display = "flex";
            }
        }
        function logout() {
            clearUserId();
            window.location.href = "index.html";
        }

        // ----------- ALGORITHME DE CALCUL AVANC√â (inchang√©)
        function removeOutliers(data, factor = 2) {
            const values = data.map(x => x.value);
            const avg = values.reduce((a,b)=>a+b,0)/values.length;
            const std = Math.sqrt(values.reduce((s,v)=>s+Math.pow(v-avg,2),0)/values.length);
            return data.filter(x => Math.abs(x.value - avg) < factor * std);
        }
        function ema(values, alpha = 0.3) {
            let result = values[0];
            for (let i = 1; i < values.length; i++) {
                result = alpha * values[i] + (1 - alpha) * result;
            }
            return result;
        }
        function tendance(history, n = 8) {
            const recent = history.slice(-n);
            if (recent.length < 2) return 0;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < recent.length; i++) {
                sumX += i; sumY += recent[i].value;
                sumXY += i * recent[i].value; sumXX += i * i;
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return slope;
        }
        function moyennePonderee(history) {
            if (!history.length) return null;
            const recent = history.slice(-12);
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const recAvg = recent.length ? recent.reduce((s,v) => s+v.value,0)/recent.length : allAvg;
            const sorted = history.map(v => v.value).sort((a, b) => a - b);
            const median = sorted.length % 2 === 0 ?
                (sorted[sorted.length/2-1] + sorted[sorted.length/2]) / 2
                : sorted[Math.floor(sorted.length/2)];
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let poidsRecent = ecartType > 0.25 ? 0.40 : 0.65;
            let poidsGlobal = 0.25;
            let poidsMedian = ecartType > 0.25 ? 0.35 : 0.10;
            return recAvg * poidsRecent + allAvg * poidsGlobal + median * poidsMedian;
        }
        async function fetchLastPredictions(N = 50) {
            try {
                const resp = await fetch('data/prediction_data.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de charger les donn√©es.");
                const lines = (await resp.text()).split('\n').filter(l=>l.trim()!=="");
                const lastLines = lines.slice(-N);
                const data = lastLines.map(row => {
                    const [timestamp, value] = row.split('|').map(item => item.trim());
                    return { timestamp, value: parseFloat(value) };
                });
                return removeOutliers(data);
            } catch {
                return [];
            }
        }
        // ----------- SYST√àME DE M√âMORISATION DE PR√âDICTION --------
        function savePredictionToStorage(prediction) {
            localStorage.setItem('aviator_last_prediction', JSON.stringify(prediction));
        }
        function getPredictionFromStorage() {
            const p = localStorage.getItem('aviator_last_prediction');
            if (!p) return null;
            try {
                return JSON.parse(p);
            } catch { return null; }
        }
        function clearPredictionStorage() {
            localStorage.removeItem('aviator_last_prediction');
        }
        function isPredictionExpired(prediction) {
            if (!prediction) return true;
            const now = Date.now();
            return now > prediction.targetTime;
        }

        // ----------- Animation logs fa√ßon matrix/termux ultra rapide (1-2s) ----------
        function getAnalysisSequence() {
            // On rallonge, on varie, on cr√©dibilise (noms pseudo-techniques, IA, stats, etc.)
            return [
                "‚Üí IA: handshake...",
                "‚Üí Authentification...",
                "‚Üí Connexion au node principal...",
                "‚Üí Chargement historique jeux...",
                "‚Üí Extraction donn√©es brutes...",
                "‚Üí Normalisation...",
                "‚Üí Suppression outliers...",
                "‚Üí Calcul EMA, m√©diane, trend...",
                "‚Üí Analyse s√©quentielle...",
                "‚Üí D√©tection pattern volatilit√©...",
                "‚Üí Pr√©diction par fusion mod√®les...",
                "‚Üí G√©n√©ration du signal...",
                "‚Üí Calcul de la variance...",
                "‚Üí Simulation random forest...",
                "‚Üí Finalisation...",
                "‚Üí Signal valid√©.",
            ];
        }
        async function showAnalysisLogs() {
            const logs = getAnalysisSequence();
            const logElem = document.getElementById('analysis-logs');
            // Ultra rapide : 1-2s maximum
            let duration = Math.random() * (2000 - 1100) + 1100; // 1.1 √† 2s
            let perLog = Math.floor(duration / logs.length);
            for (let i = 0; i < logs.length; i++) {
                logElem.textContent = logs[i];
                await new Promise(res => setTimeout(res, perLog - 5 + Math.random() * 9));
            }
            logElem.textContent = "";
        }

        // ----------- Lancement de la pr√©diction avanc√©e -----------
        async function startPrediction() {
            if (!getUserId()) {
                showIdPopup();
                return;
            }
            document.getElementById('predicted-cote').style.display = "none";
            document.getElementById('predicted-hour').style.display = "none";
            document.getElementById('error-message').textContent = '';
            document.getElementById('info-message').textContent = '';
            document.getElementById('signal-btn').disabled = true;
            interrupted = false;

            // Animation logs fa√ßon termux/matrix ultra rapide
            await showAnalysisLogs();

            // Heure cible mobile (toujours seconds arrondis)
            const now = new Date();
            const minutesToAdd = getFutureMinutes();
            const predictionTime = new Date(now.getTime() + minutesToAdd*60000);

            // R√©cup√©ration et calcul
            const history = await fetchLastPredictions(50);
            if (!history.length) {
                document.getElementById('error-message').textContent = "Erreur‚ÄØ: Impossible de charger les donn√©es.";
                document.getElementById('signal-btn').disabled = false;
                return;
            }
            let predValue = moyennePonderee(history);
            let emaValue = ema(history.map(v => v.value));
            predValue = (predValue + emaValue) / 2;
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let bruit = (Math.random() + Math.random() + Math.random() - 1.5) * ecartType * 0.28;
            predValue += bruit;
            let trend = tendance(history, 8);
            predValue += trend * 2;
            predValue *= 1 + (minutesToAdd-1.5)*0.03 + (Math.random()-0.5)*0.02;
            if (predValue < 1.01) predValue = 1.01;
            let cote = predValue.toFixed(2);

            if (interrupted) { document.getElementById('signal-btn').disabled = false; return; }

            // Affiche la pr√©diction
            document.getElementById('predicted-cote').style.display = "block";
            document.getElementById('predicted-cote').textContent = "Cote pr√©vue : " + cote;
            document.getElementById('predicted-hour').style.display = "block";
            document.getElementById('predicted-hour').textContent = "Signal pr√©vu pour‚ÄØ: " +
                predictionTime.getHours().toString().padStart(2,'0') + ":" +
                predictionTime.getMinutes().toString().padStart(2,'0') + ":" +
                predictionTime.getSeconds().toString().padStart(2,'0');
            document.getElementById('info-message').textContent = "";

            // Sauvegarde la pr√©diction dans le localStorage avec l'heure cible en ms
            savePredictionToStorage({
                cote: cote,
                targetTime: predictionTime.getTime()
            });

            document.getElementById('signal-btn').disabled = true;
            updatePredictionState();
        }

        // ----------- Gestion de la pr√©diction sauvegard√©e & minuteur -------------
        function updatePredictionState() {
            const prediction = getPredictionFromStorage();
            const now = Date.now();
            const btn = document.getElementById('signal-btn');
            const timerElem = document.getElementById('timer-remaining');
            if (prediction && !isPredictionExpired(prediction)) {
                // Affiche la pr√©diction sauvegard√©e
                document.getElementById('predicted-cote').style.display = "block";
                document.getElementById('predicted-cote').textContent = "Cote pr√©vue : " + prediction.cote;
                const d = new Date(prediction.targetTime);
                document.getElementById('predicted-hour').style.display = "block";
                document.getElementById('predicted-hour').textContent = "Signal pr√©vu pour‚ÄØ: " +
                    d.getHours().toString().padStart(2,'0') + ":" +
                    d.getMinutes().toString().padStart(2,'0') + ":" +
                    d.getSeconds().toString().padStart(2,'0');
                btn.disabled = true;
                btn.classList.add("disabled");
                document.getElementById('info-message').textContent = "Veuillez attendre l‚Äôheure du signal pour lancer une nouvelle pr√©diction.";
                // Affiche le minuteur restant
                let ms = prediction.targetTime - now;
                if (ms > 0) {
                    let s = Math.floor(ms/1000);
                    let m = Math.floor(s/60);
                    s = s%60;
                    timerElem.textContent = "Nouvelle pr√©diction dans : " + (m>0?(m+"m "):"") + s + "s";
                    timerElem.style.display = "block";
                } else {
                    timerElem.style.display = "none";
                }
            } else {
                clearPredictionStorage();
                btn.disabled = false;
                btn.classList.remove("disabled");
                document.getElementById('info-message').textContent = "";
                timerElem.style.display = "none";
            }
        }

        function getFutureMinutes() {
            const r = Math.random();
            if (r < 0.98) return 1.5 + Math.random() * 0.5;
            return 2 + Math.random() * 2;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let id = getUserId();
            if (!id) {
                document.getElementById('main-content').style.display = "none";
                await new Promise(res=>setTimeout(res, 350));
                showIdPopup();
            } else {
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
                showUserIdOnPage();
            }
            updatePredictionState();
            setInterval(function(){
                updatePredictionState();
                showUserIdOnPage();
            }, 1000);
        });
    </script>
</body>
</html>