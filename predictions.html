<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prédiction Aviator - Signal Unique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            margin: 0; padding: 0; background: radial-gradient(ellipse at 50% 20%, #191932 60%, #101019 100%); color: #f4f4f4; font-family: 'Segoe UI', Arial, sans-serif;
        }
        .main-content {
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 36px;
        }
        .header {
            width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 22px 40px 10px 40px; box-sizing: border-box;
        }
        .user-info {
            display: flex; align-items: center; gap: 14px; font-weight: 500; font-size: 1.2em;
        }
        .user-avatar {
            width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, #ff4c71 0%, #ff2222 100%);
            display: flex; align-items: center; justify-content: center; font-size: 1.4em; color: #fff; box-shadow: 0 2px 12px #ff4c7166;
        }
        .disconnect-btn {
            padding: 8px 18px; background: #2b141a; border: none; border-radius: 17px; color: #fff; font-size: 1em; cursor: pointer; font-weight: 500;
            box-shadow: 0 2px 10px #ff4c711a; transition: background 0.2s; margin-left: 16px;
        }
        .disconnect-btn:hover { background: #ff4c71; color: #fff; }
        .connection-indicator {
            display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: flex-end; transition: color 0.25s;
        }
        .conn-bubble { width: 13px; height: 13px; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 6px #2223; animation: blink 1.3s infinite;}
        .conn-bubble.good { background: #ff4c71; }
        .conn-bubble.medium { background: #ffe066;}
        .conn-bubble.bad { background: #ff2222;}
        .conn-text.good { color: #ff4c71; }
        .conn-text.medium { color: #ffe066;}
        .conn-text.bad { color: #ff2222;}
        @keyframes blink { 0%, 100% { opacity: 1;} 50% { opacity: 0.45;} }

        .prediction-box {
            background: linear-gradient(135deg, #191932 60%, #1a1221 100%);
            border-radius: 24px;
            box-shadow: 0 4px 24px #ff4c7138, 0 2px 24px #19193255;
            padding: 40px 35px;
            margin-top: 54px;
            display: flex; flex-direction: column; align-items: center;
            min-width: 330px; max-width: 96vw;
            border: 1.5px solid #332040;
        }
        .predict-title {
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 0.03em;
            margin-bottom: 18px;
            text-shadow: 0 2px 12px #ff4c7140;
        }
        .signal-btn {
            padding: 18px 52px; background: linear-gradient(90deg, #ff4c71 60%, #ffb4c7 100%);
            color: #fff;
            font-size: 1.18em; border: none; border-radius: 15px;
            font-weight: bold; letter-spacing: 1px; cursor: pointer; margin-bottom: 12px;
            transition: background 0.20s, color 0.20s, box-shadow 0.25s;
            box-shadow: 0 2px 22px #ff4c7130, 0 1px 4px #ff4c7140;
        }
        .signal-btn:disabled, .signal-btn.disabled { background: #2d1a26; color: #eee; cursor: not-allowed; box-shadow:none;}

        /* Animation cercle central améliorée */
        .big-loader-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
            width: 270px; height: 270px; margin: 0 auto 32px auto;
        }
        .big-circle-loader {
            border: 13px solid #232029;
            border-top: 13px solid #ff4c71;
            border-right: 13px solid #ffb4c7;
            border-bottom: 13px solid #ff4c71bb;
            border-left: 13px solid #291a26;
            border-radius: 50%;
            width: 205px; height: 205px;
            animation: bigspin-fast 0.42s linear infinite;
            position: absolute; top: 0; left: 0; z-index: 1;
            box-shadow: 0 8px 28px #ff4c7133, 0 0 0 10px #ff4c7112 inset, 0 0 40px 7px #ff2b4970;
        }
        @keyframes bigspin-fast {
            100% { transform: rotate(360deg);}
        }
        .cote-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            color: #fff;
            font-size: 2.8em;
            font-weight: bold;
            z-index: 2;
            background: linear-gradient(135deg,#21101d 80%,#ffb4c712 100%);
            border-radius: 1em;
            padding: 0.40em 1.1em;
            box-shadow: 0 2px 28px #ff4c7140;
            display: none;
            letter-spacing: 0.04em;
            text-align: center;
            border: 2.5px solid #ff4c71;
            text-shadow: 0 2px 6px #ffb4c751, 0 0 2px #ff4c7130;
        }
        .big-loader-container.show-cote .cote-center {
            display: block;
        }

        #analysis-logs {
            position: absolute;
            left: 50%;
            top: 100%;
            transform: translate(-50%, 18px);
            min-height: unset;
            width: 100%;
            text-align: center;
            font-size: 0.95em;
            color: #ffb4c7;
            white-space: nowrap;
            overflow: hidden;
            height: 1.4em;
            line-height: 1.4em;
            pointer-events: none;
            user-select: none;
            z-index: 3;
            font-family: 'Fira Mono', 'Consolas', 'monospace', monospace;
            letter-spacing: 0.01em;
            opacity: 0.85;
            transition: all 0.1s;
            text-shadow: 0 1px 4px #21101d, 0 0 2px #ffb4c721;
        }
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 12px 4vw 7px 4vw;}
            .user-avatar { width: 29px; height: 29px; font-size: 1em; }
            .disconnect-btn { padding: 6px 9px; font-size: 0.9em; }
            .prediction-box { padding: 18px 3vw; }
            .predicted-cote { padding: 11px 12px; font-size: 1.3em;}
            .big-loader-container { width: 150px; height: 150px;}
            .big-circle-loader { width: 90px; height: 90px; border-width: 7px;}
            .cote-center { font-size: 1.1em; padding: 0.33em 0.6em;}
            #analysis-logs { font-size: 0.82em; top: 100%; transform: translate(-50%, 9px); height: 1.2em; line-height: 1.2em; }
        }
        .predicted-cote {
            font-size: 2.1em; font-weight: bold; color: #ff4c71; margin-top: 30px; text-align: center;
            background: linear-gradient(90deg, #2d1a26 60%, #20151c 100%);
            border-radius: 14px; padding: 18px 38px;
            box-shadow: 0 2px 14px #ff4c7133;
            border: 1.2px solid #ff4c7130;
        }
        .predicted-hour {
            font-size: 1.09em;
            color: #ffb4c7;
            margin-top: 8px;
            font-weight: bold;
            text-shadow: 0 1px 6px #21101d;
        }
        .error-message {
            color: #e74c3c; font-size: 1.1em; text-align: center; margin-top: 20px;
        }
        .info-message {
            color: #ff4c71; font-size: 1em; text-align: center; margin-top: 18px;
        }
    </style>
</head>
<body>
    <!-- Connexion perdue popup -->
    <div class="popup-bg" id="lost-connection-popup">
        <div class="popup">
            <i class="fa fa-wifi-slash"></i>
            <div class="popup-title">Connexion perdue</div>
            <div class="popup-text">
                Vous avez perdu votre connexion internet.<br>
                Veuillez vérifier votre réseau pour continuer à utiliser la prédiction.
            </div>
            <button class="close-btn" onclick="closePopup()">OK</button>
        </div>
    </div>
    <!-- Popup ID joueur -->
    <div class="popup-bg" id="id-popup">
        <div class="popup">
            <div class="popup-title">Entrez votre ID joueur Aviator :</div>
            <input type="text" id="id-input" maxlength="32" placeholder="ID joueur..." autocomplete="off"/>
            <div id="id-error" style="color:#ff4c71;font-size:0.99em;"></div>
            <button class="close-btn" onclick="validateId()">Valider</button>
        </div>
    </div>
    <!-- Popup synchronisation -->
    <div class="popup-bg" id="sync-popup">
        <div class="popup">
            <div class="popup-title"><i class="fa fa-sync fa-spin"></i> Synchronisation...</div>
            <div style="font-size:1em; color:#ff4c71;">Veuillez patienter...</div>
        </div>
    </div>
    <div class="main-content" id="main-content" style="display:none;">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar"><i class="fa fa-user"></i></div>
                <span id="user-id">ID: —</span>
            </div>
            <div class="connection-indicator" id="connection-indicator">
                <span class="conn-bubble good" id="conn-bubble"></span>
                <span class="conn-text good" id="conn-text">Connecté</span>
            </div>
            <button class="disconnect-btn" onclick="logout()">Déconnexion</button>
        </div>
        <div class="prediction-box">
            <div class="predict-title">Signal Aviator</div>
            <button class="signal-btn" id="signal-btn" onclick="startPrediction()">Rechercher le signal</button>
            <!-- Animation centrale cercle -->
            <div class="big-loader-container" id="big-loader-container" style="display:none;">
                <div class="big-circle-loader"></div>
                <div class="cote-center" id="cote-center"></div>
                <div id="analysis-logs"></div>
            </div>
            <div class="predicted-cote" id="predicted-cote" style="display:none;"></div>
            <div class="predicted-hour" id="predicted-hour" style="display:none;"></div>
            <div class="error-message" id="error-message"></div>
            <div class="info-message" id="info-message"></div>
        </div>
    </div>
    <script>
        // --------- Gestion Connexion
        let interrupted = false;
        function setConnection(status) {
            const bubble = document.getElementById('conn-bubble');
            const text = document.getElementById('conn-text');
            if (status === 'good') {
                bubble.className = "conn-bubble good";
                text.className = "conn-text good";
                text.textContent = "Connecté";
            } else if (status === 'medium') {
                bubble.className = "conn-bubble medium";
                text.className = "conn-text medium";
                text.textContent = "Connexion lente";
            } else {
                bubble.className = "conn-bubble bad";
                text.className = "conn-text bad";
                text.textContent = "Déconnecté";
            }
        }
        function checkConnection() {
            if (navigator.onLine) {
                setConnection('good');
            } else {
                setConnection('bad');
                interrupted = true;
                stopBigLoader();
                document.getElementById('lost-connection-popup').style.display = "flex";
            }
        }
        window.addEventListener('online', () => { setConnection('good'); });
        window.addEventListener('offline', () => {
            setConnection('bad');
            interrupted = true;
            stopBigLoader();
            document.getElementById('lost-connection-popup').style.display = "flex";
        });
        function closePopup() {
            document.getElementById('lost-connection-popup').style.display = "none";
        }
        setInterval(checkConnection, 3000);

        // --------- Gestion ID joueur (mémoire + vérif backend)
        function getUserId() {
            return localStorage.getItem('aviator_userid');
        }
        function setUserId(id) {
            localStorage.setItem('aviator_userid', id);
        }
        function clearUserId() {
            localStorage.removeItem('aviator_userid');
        }
        function updateDisplayId() {
            const id = getUserId();
            document.getElementById('user-id').textContent = id ? "ID: " + id : "ID: —";
            document.getElementById('user-avatar').textContent = id ? id[0]?.toUpperCase() : "?";
        }

        // ---------- POPUP ID à l'arrivée (une seule fois)
        async function showIdPopup(force = false) {
            document.getElementById('id-input').value = '';
            document.getElementById('id-error').textContent = '';
            document.getElementById('id-popup').style.display = "flex";
            document.getElementById('signal-btn').disabled = true;
        }
        async function validateId() {
            const id = document.getElementById('id-input').value.trim();
            if (!/^\d{6,15}$/.test(id)) {
                document.getElementById('id-error').textContent = "ID invalide. Entrez un numéro d’ID (chiffres, min 6).";
                return;
            }
            document.getElementById('id-popup').style.display = "none";
            document.getElementById('sync-popup').style.display = "flex";
            try {
                const resp = await fetch('data/allowed_ids.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de vérifier l’ID.");
                const content = await resp.text();
                const allowedIds = content.split('\n').map(l=>l.trim()).filter(l=>l!=="");
                if (!allowedIds.includes(id)) {
                    document.getElementById('sync-popup').style.display = "none";
                    document.getElementById('id-error').textContent = "Cet ID n’existe pas dans la base.";
                    document.getElementById('id-popup').style.display = "flex";
                    return;
                }
                setUserId(id);
                document.getElementById('sync-popup').style.display = "none";
                updateDisplayId();
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
            } catch (e) {
                document.getElementById('sync-popup').style.display = "none";
                document.getElementById('id-error').textContent = "Erreur serveur: " + e.message;
                document.getElementById('id-popup').style.display = "flex";
            }
        }

        // ---------- Déconnexion
        function logout() {
            clearUserId();
            window.location.href = "index.html";
        }

        // ----------- ALGORITHME DE CALCUL AVANCÉ (50 dernières valeurs) -----------
        function removeOutliers(data, factor = 2) {
            const values = data.map(x => x.value);
            const avg = values.reduce((a,b)=>a+b,0)/values.length;
            const std = Math.sqrt(values.reduce((s,v)=>s+Math.pow(v-avg,2),0)/values.length);
            return data.filter(x => Math.abs(x.value - avg) < factor * std);
        }
        function ema(values, alpha = 0.3) {
            let result = values[0];
            for (let i = 1; i < values.length; i++) {
                result = alpha * values[i] + (1 - alpha) * result;
            }
            return result;
        }
        function tendance(history, n = 8) {
            const recent = history.slice(-n);
            if (recent.length < 2) return 0;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < recent.length; i++) {
                sumX += i;
                sumY += recent[i].value;
                sumXY += i * recent[i].value;
                sumXX += i * i;
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return slope;
        }
        function moyennePonderee(history) {
            if (!history.length) return null;
            const recent = history.slice(-12);
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const recAvg = recent.length ? recent.reduce((s,v) => s+v.value,0)/recent.length : allAvg;
            const sorted = history.map(v => v.value).sort((a, b) => a - b);
            const median = sorted.length % 2 === 0 ?
                (sorted[sorted.length/2-1] + sorted[sorted.length/2]) / 2
                : sorted[Math.floor(sorted.length/2)];
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let poidsRecent = ecartType > 0.25 ? 0.40 : 0.65;
            let poidsGlobal = 0.25;
            let poidsMedian = ecartType > 0.25 ? 0.35 : 0.10;
            return recAvg * poidsRecent + allAvg * poidsGlobal + median * poidsMedian;
        }
        async function fetchLastPredictions(N = 50) {
            try {
                const resp = await fetch('data/prediction_data.txt?_=' + Date.now());
                if (!resp.ok) throw new Error("Impossible de charger les données.");
                const lines = (await resp.text()).split('\n').filter(l=>l.trim()!=="");
                const lastLines = lines.slice(-N);
                const data = lastLines.map(row => {
                    const [timestamp, value] = row.split('|').map(item => item.trim());
                    return { timestamp, value: parseFloat(value) };
                });
                return removeOutliers(data);
            } catch {
                return [];
            }
        }

        // ----------- Animation cercle central -----------
        function showBigLoader() {
            const loader = document.getElementById('big-loader-container');
            loader.classList.remove('show-cote');
            document.getElementById('cote-center').textContent = '';
            loader.style.display = "flex";
            document.getElementById('analysis-logs').textContent = "";
        }
        function showPredictedCoteInCircle(cote) {
            const loader = document.getElementById('big-loader-container');
            document.getElementById('cote-center').textContent = cote;
            loader.classList.add('show-cote');
        }
        function stopBigLoader() {
            document.getElementById('big-loader-container').style.display = "none";
            document.getElementById('cote-center').textContent = '';
            document.getElementById('big-loader-container').classList.remove('show-cote');
            document.getElementById('analysis-logs').textContent = "";
        }

        // ----------- Séquence de faux logs d'analyse très rapide et réaliste -----------
        function getFutureMinutes() {
            // 96% : 1.5 à 2 min ; 4% : 2-4 min
            const r = Math.random();
            if (r < 0.96) return 1.5 + Math.random() * 0.5; // 1.5 à 2
            return 2 + Math.random() * 2; // 2 à 4
        }
        function getAnalysisSequence() {
            // Faux logs d'analyse très court, style ligne de commandes IA
            return [
                "→ Connexion serveur...",
                "→ Auth. clé IA...",
                "→ Téléchargement données...",
                "→ Extraction features...",
                "→ Prétraitement...",
                "→ Analyser tendances...",
                "→ IA: projection future...",
                "→ Fusion modèles...",
                "→ Calcul probabilité...",
                "→ Génération signal...",
                "→ Finalisation...",
                "→ Cote générée."
            ];
        }
        async function showAnalysisLogs() {
            const logs = getAnalysisSequence();
            const logElem = document.getElementById('analysis-logs');
            for (let i = 0; i < logs.length; i++) {
                logElem.textContent = logs[i];
                await new Promise(res => setTimeout(res, 70 + Math.random() * 30)); // Vitesse très rapide
            }
            logElem.textContent = "";
        }

        // ----------- Lancement de la prédiction avancée -----------
        async function startPrediction() {
            // Vérifie si ID mémorisé, sinon refuse
            if (!getUserId()) {
                showIdPopup();
                return;
            }
            document.getElementById('predicted-cote').style.display = "none";
            document.getElementById('predicted-hour').style.display = "none";
            document.getElementById('error-message').textContent = '';
            document.getElementById('info-message').textContent = '';
            document.getElementById('signal-btn').disabled = true;
            interrupted = false;

            // Affiche l'animation du cercle
            showBigLoader();
            document.getElementById('analysis-logs').textContent = "";

            // Lance l’animation des faux logs en parallèle du calcul de la cote
            const logsPromise = showAnalysisLogs();

            // Choix de l’heure cible
            const now = new Date();
            const minutesToAdd = getFutureMinutes();
            const predictionTime = new Date(now.getTime() + minutesToAdd*60000);

            // Récupération et calcul
            const history = await fetchLastPredictions(50);
            let cote = null;
            if (!history.length) {
                stopBigLoader();
                document.getElementById('error-message').textContent = "Erreur : Impossible de charger les données.";
                document.getElementById('signal-btn').disabled = false;
                return;
            }
            // Calcul avancé
            let predValue = moyennePonderee(history);
            let emaValue = ema(history.map(v => v.value));
            predValue = (predValue + emaValue) / 2;
            // Ajoute bruit réaliste
            const allAvg = history.reduce((s,v) => s+v.value, 0) / history.length;
            const ecartType = Math.sqrt(history.reduce((acc, v) => acc + Math.pow(v.value - allAvg, 2), 0) / history.length);
            let bruit = (Math.random() + Math.random() + Math.random() - 1.5) * ecartType * 0.28;
            predValue += bruit;
            // Ajoute tendance
            let trend = tendance(history, 8);
            predValue += trend * 2;
            // Influe légèrement selon l’horizon: plus c’est loin, plus incertain/élevé
            predValue *= 1 + (minutesToAdd-1.5)*0.03 + (Math.random()-0.5)*0.02;
            // Jamais sous 1.01
            if (predValue < 1.01) predValue = 1.01;
            cote = predValue.toFixed(2);

            // Attend la fin de l’animation (logs) et du temps de chargement réaliste
            await Promise.all([
                logsPromise,
                new Promise(res => setTimeout(res, 700+Math.random()*300))
            ]);
            if (interrupted) { stopBigLoader(); document.getElementById('signal-btn').disabled = false; return; }

            // Affiche la cote au centre du cercle pendant 1.1s
            showPredictedCoteInCircle(cote);
            await new Promise(res => setTimeout(res, 900));
            if (interrupted) { stopBigLoader(); document.getElementById('signal-btn').disabled = false; return; }
            stopBigLoader();
            document.getElementById('analysis-logs').textContent = "";

            // Affiche la prédiction
            document.getElementById('predicted-cote').style.display = "block";
            document.getElementById('predicted-cote').textContent = "Cote prévue : " + cote;
            // Affiche l’heure cible
            document.getElementById('predicted-hour').style.display = "block";
            document.getElementById('predicted-hour').textContent = "Signal prévu pour : " +
                predictionTime.getHours().toString().padStart(2,'0') + ":" +
                predictionTime.getMinutes().toString().padStart(2,'0') + ":" +
                predictionTime.getSeconds().toString().padStart(2,'0');
            // Enlève l’ancien message générique, ne rien afficher ici
            document.getElementById('info-message').textContent = "";
            document.getElementById('signal-btn').disabled = false;
        }

        // ----------- INIT
        document.addEventListener('DOMContentLoaded', async () => {
            // Vérifie présence ID
            let id = getUserId();
            updateDisplayId();
            if (!id) {
                document.getElementById('main-content').style.display = "none";
                await new Promise(res=>setTimeout(res, 350)); // petit délai UX
                showIdPopup();
            } else {
                document.getElementById('main-content').style.display = "flex";
                document.getElementById('signal-btn').disabled = false;
            }
        });
    </script>
</body>
</html>